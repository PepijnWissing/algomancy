name: pytest

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.14"

jobs:
  test-root:
    name: Root tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install uv + test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv pytest pytest-cov

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install project dependencies
        run: |
          uv sync --frozen

      - name: Run root tests
        run: |
          if [ -d "tests" ]; then
            uv run pytest tests -v --junitxml=pytest-results-root.xml
          else
            echo "No root tests directory found."
          fi

      - name: Upload root pytest results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results-root
          path: pytest-results-root.xml


  test-packages:
    name: Package tests (${{ matrix.package }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        package:
          - algomancy-cli
          - algomancy-content
          - algomancy-data
          - algomancy-gui
          - algomancy-scenario
          - algomancy-utils

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install uv + test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv pytest pytest-cov

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install project dependencies
        run: |
          uv sync --frozen

      - name: Run tests for ${{ matrix.package }}
        run: |
          PKG="packages/${{ matrix.package }}"

          if [ -d "$PKG/tests" ]; then
            uv run pytest "$PKG/tests" -v \
              --junitxml="pytest-results-${{ matrix.package }}.xml"
          else
            echo "No tests directory found for ${{ matrix.package }}"
          fi

      - name: Upload pytest results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results-${{ matrix.package }}
          path: pytest-results-${{ matrix.package }}.xml
